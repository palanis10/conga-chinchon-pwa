<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Conga / Chinchón – Alanis Scorekeeper</title>

<!-- PWA + iOS -->
<meta name="theme-color" content="#0f1220" />
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="icons/icon-512.png">
<link rel="manifest" href="manifest.webmanifest">

<style>
  :root{
    --bg:#0f1220; --card:#171a2b; --muted:#2a2f4a; --text:#e8ecff; --sub:#b8c0ff;
    --accent:#7aa2ff; --accent-2:#4ee1a0; --danger:#ff6b6b; --warn:#ffb020;
    --shadow: 0 8px 24px rgba(0,0,0,.35); --radius:16px;
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0; font-family: ui-sans-serif, -apple-system, Segoe UI, Roboto, Arial, Noto Sans, sans-serif;
    background: radial-gradient(1200px 800px at 20% -10%, #162040, #0d1020 60%) fixed, var(--bg);
    color:var(--text); -webkit-font-smoothing:antialiased; line-height:1.35;}
  .app{max-width:980px; margin:0 auto; padding:18px 14px 120px;}
  header{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:14px;}
  .title{font-weight:800; letter-spacing:.3px; font-size: clamp(18px, 4.5vw, 28px); display:flex; align-items:center; gap:10px;}
  .chip{background:linear-gradient(135deg, var(--accent), #a77dff); color:#0b0f1f; padding:4px 10px; border-radius:999px; font-weight:800; font-size:12px; text-transform:uppercase; letter-spacing:.6px;}
  .brand{opacity:.9; font-weight:800;}
  .btn{appearance:none; border:0; cursor:pointer; user-select:none; padding:10px 14px; border-radius:12px;
    background: linear-gradient(135deg, #1a2344, #121a34); border:1px solid rgba(255,255,255,.08);
    color:var(--text); font-weight:700; letter-spacing:.2px; transition:.15s;}
  .btn:hover{ filter:brightness(1.07)} .btn:active{ transform:translateY(1px)}
  .btn.primary{background: linear-gradient(135deg, var(--accent), #9f7cff); color:#0b0f1f;}
  .btn.success{background: linear-gradient(135deg, var(--accent-2), #9cffc8); color:#001c12;}
  .btn.warn{background: linear-gradient(135deg, #ffb020, #ffd27a); color:#2d1500;}
  .btn.ghost{background: transparent; border:1px dashed rgba(255,255,255,.2);}
  .card{background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.0)) , var(--card);
    border:1px solid rgba(255,255,255,.06); border-radius: var(--radius); box-shadow: var(--shadow); padding:12px;}

  .settings{display:grid; grid-template-columns: 1fr; gap:10px;}
  @media (min-width:680px){ .settings{grid-template-columns: 1.1fr .9fr 1fr;} }
  label{font-size:12px; color:var(--sub); display:block; margin-bottom:6px}
  input[type="number"], input[type="text"]{width:100%; background:#0f1428; border:1px solid var(--muted);
    color:var(--text); padding:10px 12px; border-radius:12px; outline:none;}
  input[type="number"]::-webkit-outer-spin-button, input[type="number"]::-webkit-inner-spin-button{ -webkit-appearance:none; margin:0;}
  .switch{display:flex; align-items:center; gap:10px; background:#0f1428; border:1px solid var(--muted); padding:10px 12px; border-radius:12px; height:42px;}

  .players{ margin-top:12px } .players header{ margin:0 0 6px 0; padding:0 6px; color:var(--sub); font-size:12px; }

  /* Row layout: big avatar, protected score column */
  .row{
    display:grid;
    grid-template-columns: 30px 1fr 84px 108px; /* drag | name+avatar | score | actions */
    align-items:center; gap:10px;
    padding:10px; border-radius:14px;
    border:1px solid rgba(255,255,255,.06);
    background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,0));
    margin-bottom:8px;
  }
  @media (min-width:760px){ .row{ grid-template-columns: 34px 1fr 110px 132px; } }
  .drag{ cursor:grab; text-align:center; font-size:18px; color:var(--sub) }
  .row.dealer{ border-color: rgba(78,225,160,.6); box-shadow: 0 0 0 2px rgba(78,225,160,.25) inset; }

  .name-wrap{ display:flex; align-items:center; gap:12px; min-width:0; }
  .avatar{
    width:48px; height:48px; border-radius:50%; flex:0 0 auto; display:grid; place-items:center;
    background:#0f1428; border:1px solid rgba(255,255,255,.14); overflow:hidden; font-weight:800;
  }
  .row.dealer .avatar{ box-shadow: 0 0 0 3px #4ee1a0, 0 0 0 6px rgba(78,225,160,.25); }
  .avatar img{ width:100%; height:100%; object-fit:cover; display:block; }
  .playerName{ flex:1; min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; font-size:18px; font-weight:800 }
  .stars{ color:#ff6b6b; font-size:15px; letter-spacing:.8px; white-space:nowrap }

  .score{ font-variant-numeric: tabular-nums; font-weight:900; text-align:right; font-size:18px; }
  .score.over{ color:var(--danger) }

  .actions{ display:flex; gap:6px; justify-content:flex-end }
  .iconbtn{ width:36px; height:36px; display:grid; place-items:center; border-radius:10px; border:1px solid rgba(255,255,255,.08); background:#0f1428; color:var(--text); cursor:pointer; }
  .iconbtn.crown{ opacity:.6 } .iconbtn.crown:hover{ opacity:1 }
  .iconbtn.danger{ background: linear-gradient(135deg, #41141b, #2a0e12); color:#ff9aa8; border-color:rgba(255,0,0,.2) }

  .banner{ margin:10px 0; padding:10px 12px; border-radius:14px; border:1px solid rgba(255,255,255,.1);
    background: linear-gradient(90deg, rgba(78,225,160,.15), rgba(122,162,255,.1)); color:#d7fff0; display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:wrap; }
  .banner .tag{ background:#0f1428; border:1px solid rgba(255,255,255,.08); padding:4px 8px; border-radius:999px; font-size:12px; color:#b8c0ff }

  dialog{ width:min(720px, 96vw); border-radius:16px; border:1px solid rgba(255,255,255,.12);
    background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01)) , #0f1428; color:var(--text);
    box-shadow: 0 24px 64px rgba(0,0,0,.55); }
  dialog::backdrop{ background: rgba(2,6,23,.55) }
  .modal-head{ padding:14px 16px; border-bottom:1px solid rgba(255,255,255,.08); display:flex; align-items:center; justify-content:space-between; gap:10px }
  .modal-body{ padding:14px 16px } .modal-foot{ padding:14px 16px; border-top:1px solid rgba(255,255,255,.08); display:flex; gap:8px; justify-content:flex-end; flex-wrap:wrap }
  .grid-rows{ display:grid; gap:8px }
  .round-row{ display:grid; grid-template-columns: 1fr 120px 70px; gap:10px; align-items:center; padding:8px; border:1px dashed rgba(255,255,255,.15); border-radius:12px;
    background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.00)); }
  .round-row .minus10{ width:100%; height:40px; border-radius:10px; border:1px solid rgba(255,255,255,.12); background:linear-gradient(135deg, #1c243e, #121a34); color:var(--text); font-weight:800; }

  .error{ color:var(--danger); font-weight:700; margin-right:auto }
  .hint{ color:var(--sub); font-size:12px }

  @media (max-width: 480px){
    .row{ grid-template-columns: 30px 1fr 74px 96px; gap:8px; }
    .iconbtn{ width:32px; height:32px; }
    .score{ font-size:17px; }
  }

  /* WIN OVERLAY */
  .win-overlay {
    position: fixed; inset: 0; display: none; align-items: center; justify-content: center;
    background: rgba(5,8,20,.55); z-index: 9999; padding: 16px;
  }
  .win-card {
    width: min(560px, 94vw); border-radius: 20px; padding: 14px;
    border: 1px solid rgba(255,255,255,.12);
    background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02)), #0f1428;
    box-shadow: 0 24px 64px rgba(0,0,0,.55); position: relative; overflow: hidden;
  }
  .win-head { display:flex; align-items:center; gap:12px; }
  .win-photo { width:72px; height:72px; border-radius:50%; overflow:hidden; border:2px solid #4ee1a0; box-shadow:0 0 0 6px rgba(78,225,160,.25); }
  .win-photo img{ width:100%; height:100%; object-fit:cover; }
  .win-name { font-size: 22px; font-weight: 900; }
  .win-sub { color:#b8c0ff; }
  #confettiCanvas { position:absolute; inset:0; pointer-events:none; }
  .win-actions { display:flex; gap:8px; justify-content:flex-end; margin-top:10px; flex-wrap:wrap; }

  /* CROP MODAL */
  #cropDialog canvas { width: 100%; height: auto; background:#0e1326; border-radius:12px; border:1px solid rgba(255,255,255,.12); touch-action: none; }
  .crop-controls { display:flex; gap:10px; align-items:center; justify-content:space-between; margin-top:10px; }
  .crop-frame-hint { color:#b8c0ff; font-size:12px; }

  /* CUT HISTORY */
  .history-list { display:grid; gap:8px; max-height:50vh; overflow:auto; }
  .history-item { padding:8px; border-radius:10px; border:1px solid rgba(255,255,255,.08); background:rgba(255,255,255,.02); }
</style>
</head>
<body>
<div class="app" id="app">
  <header>
    <div class="title">
      <span class="chip">Conga / Chinchón</span>
      <span class="brand">Alanis Scorekeeper</span>
    </div>
    <div class="lang">
      <button class="btn ghost" id="resetScoresBtn" title="Reset all scores to 0" data-i18n-title="resetTip" data-i18n="resetScores">Reset scores</button>
      <button class="btn" id="langToggle" title="Cambiar idioma / Change language">ES</button>
    </div>
  </header>

  <section class="card settings" aria-label="Game settings">
    <div>
      <label for="limitInput" data-i18n="limitLabel">Limit (default 100)</label>
      <input id="limitInput" type="number" inputmode="numeric" min="1" step="1" />
    </div>
    <div class="switch" role="group" aria-label="Auto advance dealer">
      <input id="autoAdvance" type="checkbox" />
      <label for="autoAdvance" style="margin:0" data-i18n="autoAdvance">Auto-advance dealer after round</label>
    </div>
    <div class="dealer-badge">
      <div><strong data-i18n="nextDealer">Next dealer:</strong> <span id="nextDealerName">—</span></div>
      <div class="hint" data-i18n="dealerHint">Tap and hold the avatar (or use 👑) to set dealer.</div>
    </div>
  </section>

  <section class="players">
    <header><div data-i18n="players">Players</div></header>
    <div id="playersList" aria-live="polite"></div>
    <button class="btn ghost" id="addPlayerBtn" style="width:100%; margin-top:6px" data-i18n="addPlayer">+ Add player</button>
  </section>

  <section id="banner" class="banner" style="display:none" aria-live="polite">
    <div><strong id="bannerText"></strong></div>
    <div class="tag" data-i18n="gameOver">Game over</div>
    <div style="margin-left:auto; display:flex; gap:8px">
      <button class="btn success" id="newGameBtn" data-i18n="newGame">New game</button>
    </div>
  </section>

  <section class="card toolbar" aria-label="Actions">
    <button class="btn primary" id="newRoundBtn" data-i18n="newRound">New round</button>
    <button class="btn" id="exportBtn" title="Download CSV" data-i18n="exportCSV">Export CSV</button>
    <button class="btn warn" id="clearAllBtn" title="Remove all players and settings" data-i18n="clearAll">Clear all</button>
  </section>
</div>

<!-- Round dialog -->
<dialog id="roundDialog" aria-labelledby="roundTitle">
  <div class="modal-head">
    <div>
      <div id="roundTitle" style="font-weight:800" data-i18n="roundTitle">New Round</div>
      <div class="hint" data-i18n="roundHint">Enter per-player points (negatives allowed). Quick “−10” applies to the input, not the total.</div>
    </div>
    <button class="btn ghost" onclick="roundDialog.close()" data-i18n="close">Close</button>
  </div>
  <form id="roundForm" method="dialog">
    <div class="modal-body">
      <div class="grid-rows" id="roundRows"></div>
      <div style="margin-top:10px">
        <label style="margin-bottom:8px; display:block"><strong data-i18n="whoCut">Who cut (cortó)?</strong> <span class="hint" data-i18n="optional">(optional)</span></label>
        <div class="cutters" id="cuttersGroup" role="radiogroup" aria-label="Cutter select"></div>
      </div>
    </div>
    <div class="modal-foot">
      <div id="roundError" class="error" style="display:none"></div>
      <button type="button" class="btn ghost" onclick="roundDialog.close()" data-i18n="cancel">Cancel</button>
      <button id="applyRoundBtn" type="submit" class="btn success" data-i18n="apply">Apply</button>
    </div>
  </form>
</dialog>

<!-- Edit player dialog -->
<dialog id="editDialog" aria-labelledby="editTitle">
  <div class="modal-head">
    <div id="editTitle" style="font-weight:800" data-i18n="editPlayer">Edit player</div>
    <button class="btn ghost" onclick="editDialog.close()" data-i18n="close">Close</button>
  </div>
  <form id="editForm" method="dialog">
    <div class="modal-body">
      <input type="hidden" id="editId" />
      <div style="display:grid; gap:10px">
        <div>
          <label for="editName" data-i18n="name">Name</label>
          <input id="editName" type="text" required />
        </div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px">
          <div>
            <label for="editScore" data-i18n="score">Score</label>
            <input id="editScore" type="number" step="1" />
          </div>
          <div>
            <label for="editReeng" data-i18n="reenganches">Reenganches</label>
            <input id="editReeng" type="number" step="1" min="0" />
          </div>
        </div>

        <!-- Photo controls and dealer switch -->
        <div style="display:grid; gap:10px; margin-top:8px">
          <div>
            <label>Photo</label>
            <div style="display:flex; gap:8px; flex-wrap:wrap">
              <button type="button" class="btn" id="changePhotoBtn">Change photo</button>
              <button type="button" class="btn ghost" id="removePhotoBtn">Remove photo</button>
              <button type="button" class="btn ghost" id="viewHistoryBtn">View cut history</button>
            </div>
          </div>
          <label class="switch" style="display:flex; align-items:center; gap:10px">
            <input id="setDealerSwitch" type="checkbox">
            <span>Set as next dealer</span>
          </label>
        </div>
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn ghost" type="button" onclick="editDialog.close()" data-i18n="cancel">Cancel</button>
      <button class="btn success" type="submit" data-i18n="save">Save</button>
    </div>
  </form>
</dialog>

<!-- Win overlay -->
<div class="win-overlay" id="winOverlay" aria-live="polite">
  <div class="win-card">
    <canvas id="confettiCanvas"></canvas>
    <div class="win-head">
      <div class="win-photo"><img id="winPhoto" alt=""></div>
      <div>
        <div class="win-name" id="winName">Winner</div>
        <div class="win-sub" id="winSubtitle">Game over</div>
      </div>
    </div>
    <div class="win-actions">
      <button class="btn success" id="winCloseBtn">Close</button>
    </div>
  </div>
</div>

<!-- Audio (tiny embedded fanfare) -->
<audio id="winSound" preload="auto">
  <source src="data:audio/mp3;base64,//uQZAAAAAAAAAAAAAAAAAAAAAAAACwAAAAAAQAAABgAABcAAABWAAABAAABAAAABAAAAAEAAAEAAABbAAABAAAAPwD///8AAP//AAD//wAA//8AAH//AP//AAD//wD//wAA//8AAH//AP//AAD//wD//wAA" type="audio/mpeg">
</audio>

<!-- Crop dialog -->
<dialog id="cropDialog" aria-labelledby="cropTitle">
  <div class="modal-head">
    <div id="cropTitle" style="font-weight:800">Crop photo</div>
    <button class="btn ghost" onclick="cropDialog.close()">Close</button>
  </div>
  <div class="modal-body">
    <div class="crop-frame-hint">Drag to position. Pinch to zoom (on phone) or use slider.</div>
    <canvas id="cropCanvas" width="600" height="600"></canvas>
    <div class="crop-controls">
      <input id="cropZoom" type="range" min="0.6" max="3" step="0.01" value="1" style="flex:1">
      <button class="btn" id="cropReset">Reset</button>
    </div>
  </div>
  <div class="modal-foot">
    <button class="btn ghost" onclick="cropDialog.close()">Cancel</button>
    <button class="btn success" id="cropSave">Save</button>
  </div>
</dialog>

<!-- Cut history dialog -->
<dialog id="historyDialog" aria-labelledby="historyTitle">
  <div class="modal-head">
    <div id="historyTitle" style="font-weight:800">Cut history</div>
    <button class="btn ghost" onclick="historyDialog.close()">Close</button>
  </div>
  <div class="modal-body">
    <div class="history-list" id="historyList"></div>
  </div>
</dialog>

<!-- Row template -->
<template id="playerRowTpl">
  <div class="row" draggable="true" aria-grabbed="false">
    <div class="drag" title="Drag to reorder" aria-hidden="true">≡</div>
    <div class="name-wrap">
      <div class="avatar" aria-hidden="true"><span class="initials"></span></div>
      <strong class="playerName"></strong>
      <span class="stars" aria-label="Reenganches"></span>
    </div>
    <div class="score" aria-label="Score"><span class="scoreVal">0</span></div>
    <div class="actions">
      <button class="iconbtn crown" title="Set as next dealer" data-role="dealer" aria-label="Set dealer">👑</button>
      <button class="iconbtn" title="Edit player" data-action="edit" aria-label="Edit player">✎</button>
      <button class="iconbtn danger" title="Remove player" data-action="remove" aria-label="Remove player">🗑</button>
    </div>
  </div>
</template>

<!-- Hidden file input (no capture so iOS shows Camera or Photo Library) -->
<input id="photoInput" type="file" accept="image/*" hidden>

<script>
(() => {
  "use strict";

  /* i18n */
  const I18N = {
    en:{title:"Scorekeeper",resetScores:"Reset scores",resetTip:"Reset all scores to 0",limitLabel:"Limit (default 100)",autoAdvance:"Auto-advance dealer after round",nextDealer:"Next dealer:",dealerHint:"Tap and hold the avatar (or use 👑) to set dealer.",players:"Players",addPlayer:"+ Add player",gameOver:"Game over",newGame:"New game",newRound:"New round",exportCSV:"Export CSV",clearAll:"Clear all",roundTitle:"New Round",roundHint:"Enter per-player points (negatives allowed). Quick “−10” applies to the input, not the total.",whoCut:"Who cut (cortó)?",optional:"(optional)",close:"Close",cancel:"Cancel",apply:"Apply",editPlayer:"Edit player",name:"Name",score:"Score",reenganches:"Reenganches",save:"Save",winCut:"wins! Cut victory (all others > limit)",cutterInvalid:"Invalid cutter selected.",cutterExceeds:(limit,projected)=>`Cutter cannot exceed ${limit}. (Projected: ${projected})`,player:"Player",current:"Current"},
    es:{title:"Marcador",resetScores:"Reiniciar puntajes",resetTip:"Poner todos los puntajes en 0",limitLabel:"Límite (por defecto 100)",autoAdvance:"Avanzar repartidor automáticamente después de la ronda",nextDealer:"Próximo repartidor:",dealerHint:"Mantén presionado el avatar (o usa 👑) para marcar repartidor.",players:"Jugadores",addPlayer:"+ Agregar jugador",gameOver:"Partida terminada",newGame:"Nueva partida",newRound:"Nueva ronda",exportCSV:"Exportar CSV",clearAll:"Limpiar todo",roundTitle:"Nueva ronda",roundHint:"Ingresa los puntos por jugador (se permiten negativos). “−10” aplica al campo, no al total.",whoCut:"¿Quién cortó?",optional:"(opcional)",close:"Cerrar",cancel:"Cancelar",apply:"Aplicar",editPlayer:"Editar jugador",name:"Nombre",score:"Puntaje",reenganches:"Reenganches",save:"Guardar",winCut:"¡gana! Corte con victoria (los demás > límite)",cutterInvalid:"Cortador inválido.",cutterExceeds:(limit,projected)=>`El cortador no puede pasar de ${limit}. (Proyectado: ${projected})`,player:"Jugador",current:"Actual"}
  };
  const LangKey="conga_lang";
  const detectLang=()=>{const s=localStorage.getItem(LangKey); if(s&&I18N[s]) return s; return (navigator.language||"en").toLowerCase().startsWith("es")?"es":"en";};
  let lang=detectLang();
  const t=(k)=> (typeof I18N[lang][k]==="string")?I18N[lang][k]:(I18N.en[k]||k);
  const applyI18n=()=>{document.documentElement.lang=lang; document.querySelectorAll("[data-i18n]").forEach(el=>{el.textContent=t(el.getAttribute("data-i18n"));}); document.querySelectorAll("[data-i18n-title]").forEach(el=>{el.title=t(el.getAttribute("data-i18n-title"));}); document.getElementById("langToggle").textContent=(lang==="es"?"EN":"ES");};

  /* State */
  const storageKey="conga_state_final_v1";
  let players=[], limit=100, nextDealerId=null, autoAdvanceDealer=true, gameOver=false;

  /* Cut history (simple) */
  let cutsHistory=[]; // [{id,name,round,timestamp,result}]
  let roundCounter=0;

  /* Utils */
  const $=s=>document.querySelector(s);
  const uid=()=> "p"+Math.random().toString(36).slice(2)+Date.now().toString(36);
  const clampInt=(v,d=0)=>Number.isFinite(+v)?Math.trunc(+v):d;
  const initials=(n)=> (n||" ").trim().split(/\s+/).map(s=>s[0]).join("").slice(0,2).toUpperCase();

  const save=()=>{localStorage.setItem(storageKey, JSON.stringify({players,limit,nextDealerId,autoAdvanceDealer,gameOver,cutsHistory,roundCounter})); localStorage.setItem(LangKey,lang);};
  const load=()=>{try{const s=JSON.parse(localStorage.getItem(storageKey)||"{}"); players=s.players||[]; limit=Number.isFinite(s.limit)?s.limit:100; nextDealerId=(typeof s.nextDealerId==="string")?s.nextDealerId:(players[0]?.id??null); autoAdvanceDealer=!!s.autoAdvanceDealer; gameOver=!!s.gameOver; cutsHistory=s.cutsHistory||[]; roundCounter=s.roundCounter||0;}catch{} const L=localStorage.getItem(LangKey); if(L&&I18N[L]) lang=L;};

  /* Render */
  const list=$("#playersList"), rowTpl=document.getElementById("playerRowTpl");
  function render(){
    $("#limitInput").value=limit; $("#autoAdvance").checked=autoAdvanceDealer;
    $("#nextDealerName").textContent=players.find(p=>p.id===nextDealerId)?.name||"—";
    $("#banner").style.display=gameOver?"":"none";
    list.innerHTML="";
    players.forEach((p,i)=>{
      const n=rowTpl.content.firstElementChild.cloneNode(true);
      n.dataset.index=i; n.dataset.id=p.id;
      n.addEventListener("dragstart",dragStart); n.addEventListener("dragover",dragOver); n.addEventListener("drop",drop); n.addEventListener("dragend",dragEnd);
      if(p.id===nextDealerId) n.classList.add("dealer");

      // name/visuals
      const avatarBox=n.querySelector(".avatar");
      const init=avatarBox.querySelector(".initials");
      init.textContent=initials(p.name);
      if(p.avatar){ avatarBox.innerHTML=`<img alt="" src="${p.avatar}">`; }
      // long-press avatar to set dealer
      attachLongPress(avatarBox, ()=>setDealer(p.id));

      n.querySelector(".playerName").textContent=p.name;
      n.querySelector(".stars").textContent="★".repeat(Math.max(0,p.reenganches||0));

      // score
      const sv=n.querySelector(".scoreVal"); sv.textContent=clampInt(p.score||0);
      if((p.score||0)>limit) n.querySelector(".score").classList.add("over"); else n.querySelector(".score").classList.remove("over");

      // actions
      n.querySelector('[data-role="dealer"]').onclick=()=>setDealer(p.id);
      n.querySelector('[data-action="edit"]').onclick=()=>openEdit(p.id);
      n.querySelector('[data-action="remove"]').onclick=()=>removePlayer(p.id);

      list.appendChild(n);
    });
    $("#newRoundBtn").disabled=players.length===0||gameOver; $("#exportBtn").disabled=players.length===0; $("#resetScoresBtn").disabled=players.length===0;
    applyI18n(); save();
  }

  /* Long-press helper */
  function attachLongPress(el, cb){
    let t;
    const start = ()=>{ t=setTimeout(cb,650); };
    const end = ()=>{ clearTimeout(t); };
    el.addEventListener('touchstart', start, {passive:true});
    el.addEventListener('mousedown', start);
    ['touchend','touchcancel','mouseup','mouseleave'].forEach(ev=>el.addEventListener(ev, end));
  }

  /* Drag & drop */
  let dragIdx=null;
  const dragStart=e=>{dragIdx=+e.currentTarget.dataset.index; e.dataTransfer.effectAllowed="move"; e.dataTransfer.setData("text/plain", String(dragIdx)); e.currentTarget.setAttribute("aria-grabbed","true");};
  const dragOver=e=>{e.preventDefault(); e.dataTransfer.dropEffect="move";};
  const drop=e=>{e.preventDefault(); const from=dragIdx??+e.dataTransfer.getData("text/plain"); const to=+e.currentTarget.dataset.index; if(Number.isInteger(from)&&Number.isInteger(to)&&from!==to){ const arr=players.slice(); const [m]=arr.splice(from,1); arr.splice(to,0,m); const keep=nextDealerId; players=arr; nextDealerId=keep; render(); }};
  const dragEnd=e=>{e.currentTarget.setAttribute("aria-grabbed","false"); dragIdx=null;};

  /* Dealer */
  const setDealer=id=>{ if(players.some(p=>p.id===id)){ nextDealerId=id; render(); } };
  const advanceDealer=()=>{ if(!players.length||!nextDealerId) return; const i=players.findIndex(p=>p.id===nextDealerId); nextDealerId=players[(i>=0&&i<players.length-1)?i+1:0].id; };

  /* CRUD */
  const addPlayer=(name="")=>{ const p={id:uid(), name:name||`${t("player")} ${players.length+1}`, score:0, reenganches:0, avatar:null}; players.push(p); if(!nextDealerId) nextDealerId=p.id; gameOver=false; render(); };
  const removePlayer=id=>{ const i=players.findIndex(p=>p.id===id); if(i<0) return; const was=players[i].id===nextDealerId; players.splice(i,1); if(!players.length) nextDealerId=null; else if(was) nextDealerId=players[Math.min(i,players.length-1)].id; render(); };

  /* Photo input */
  const photoInput=document.getElementById("photoInput"); let photoTarget=null;
  photoInput.removeAttribute('capture'); // allow both Camera and Photo Library
  photoInput.addEventListener("change", async()=>{
    if(!photoTarget||!photoInput.files?.[0]) return;
    const file=photoInput.files[0];
    const dataUrl=await new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); });
    openCropper(dataUrl, photoTarget); // cropper flow
    photoTarget=null;
  });

  /* Edit dialog */
  const editDlg=document.getElementById("editDialog"), editForm=document.getElementById("editForm");
  const setDealerSwitch = ()=>document.getElementById("setDealerSwitch");
  function openEdit(id){
    const p=players.find(x=>x.id===id); if(!p) return;
    $("#editId").value=p.id;
    $("#editName").value=p.name;
    $("#editScore").value=clampInt(p.score||0);
    $("#editReeng").value=clampInt(p.reenganches||0);
    setDealerSwitch().checked = (p.id === nextDealerId);
    // buttons
    document.getElementById("changePhotoBtn").onclick = ()=>{ photoTarget=p.id; photoInput.value=""; photoInput.click(); };
    document.getElementById("removePhotoBtn").onclick = ()=>{ p.avatar=null; render(); };
    document.getElementById("viewHistoryBtn").onclick = ()=> openHistory(p.id);
    editDlg.showModal();
  }
  editForm.addEventListener("submit", (e)=>{
    e.preventDefault();
    const id=$("#editId").value; const p=players.find(x=>x.id===id); if(!p) return editDlg.close();
    p.name = String($("#editName").value||"").trim() || p.name;
    p.score = clampInt($("#editScore").value, p.score);
    p.reenganches = Math.max(0, clampInt($("#editReeng").value, p.reenganches));
    if (setDealerSwitch().checked) nextDealerId = p.id;
    editDlg.close(); render();
  });

  /* Round modal + logic */
  const roundDlg=document.getElementById("roundDialog"), rows=document.getElementById("roundRows"), cutters=document.getElementById("cuttersGroup"), rErr=document.getElementById("roundError"), applyBtn=document.getElementById("applyRoundBtn");
  const openRound=()=>{ rows.innerHTML=""; cutters.innerHTML=""; players.forEach(p=>{ const r=document.createElement("div"); r.className="round-row"; const lab=document.createElement("label"); lab.setAttribute("for","rr_"+p.id); lab.innerHTML=`<strong>${p.name}</strong><div class="hint">${t("current")}: ${p.score||0}</div>`; const inp=document.createElement("input"); inp.id="rr_"+p.id; inp.type="number"; inp.step="1"; inp.inputMode="numeric"; inp.placeholder="0"; inp.dataset.pid=p.id; inp.addEventListener("input", validateRound); const minus=document.createElement("button"); minus.type="button"; minus.className="minus10"; minus.textContent="−10"; minus.onclick=()=>{ inp.value=clampInt((inp.value===""?0:+inp.value)-10); validateRound(); }; r.append(lab,inp,minus); rows.appendChild(r);
    const chip=document.createElement("label"); chip.className="cut-chip"; chip.style.cssText="display:inline-flex;align-items:center;gap:8px;border:1px dashed rgba(255,255,255,.2);padding:6px 10px;border-radius:999px;margin:4px 6px 0 0;cursor:pointer;"; chip.innerHTML=`<input class="visually-hidden" type="radio" name="cutter" value="${p.id}"><span>✂️ ${p.name}</span>`; chip.querySelector("input").addEventListener("change", validateRound); cutters.appendChild(chip);
  }); const none=document.createElement("label"); none.className="cut-chip"; none.style.cssText="display:inline-flex;align-items:center;gap:8px;border:1px dashed rgba(255,255,255,.2);padding:6px 10px;border-radius:999px;margin:4px 6px 0 0;cursor:pointer;"; none.innerHTML=`<input class="visually-hidden" type="radio" name="cutter" value="" checked><span>—</span>`; none.querySelector("input").addEventListener("change", validateRound); cutters.insertBefore(none, cutters.firstChild);
    rErr.style.display="none"; applyBtn.disabled=false; roundDlg.showModal(); };
  const roundInputs=()=>{ const m={}; players.forEach(p=>{ const el=document.getElementById("rr_"+p.id); m[p.id]=clampInt(el?.value??0,0); }); return m; };
  const selectedCutter=()=>{ const sel=document.querySelector('input[name="cutter"]:checked'); const v=sel?sel.value:""; return v||null; };
  function validateRound(){ const inputs=roundInputs(); const cid=selectedCutter(); if(!cid){ rErr.style.display="none"; applyBtn.disabled=false; return true; } const c=players.find(p=>p.id===cid); if(!c){ rErr.textContent=t("cutterInvalid"); rErr.style.display=""; applyBtn.disabled=true; return false; } const proj=clampInt(c.score||0)+clampInt(inputs[c.id]??0); if(proj>limit){ rErr.textContent=(I18N[lang].cutterExceeds||I18N.en.cutterExceeds)(limit,proj); rErr.style.display=""; applyBtn.disabled=true; return false; } rErr.style.display="none"; applyBtn.disabled=false; return true; }

  function applyRound(inputs,cid){
    const proj=new Map(); players.forEach(p=>{ proj.set(p.id, clampInt(p.score||0)+clampInt(inputs[p.id]??0)); });

    // start round counter & history if cutter selected
    roundCounter += 1;
    if (cid){
      const cutter = players.find(p=>p.id===cid);
      cutsHistory.push({ id: cid, name: cutter?.name||"—", round: roundCounter, timestamp: Date.now(), result: "played" });
    }

    /* Two-player auto-win check BEFORE reenganche: one ≥101 and the other ≤100 */
    if(players.length===2){
      const [a,b]=players; const A=proj.get(a.id), B=proj.get(b.id);
      if(A>=limit+1 && B<=limit){ a.score=A; b.score=B; gameOver=true; showWinOverlay(b); save(); render(); return; }
      if(B>=limit+1 && A<=limit){ a.score=A; b.score=B; gameOver=true; showWinOverlay(a); save(); render(); return; }
    }

    /* Cutter immediate win (strict) */
    if(cid){
      const cProj=proj.get(cid); const ok=cProj<=limit;
      const others=players.filter(p=>p.id!==cid); const allOver=others.every(o=>(proj.get(o.id)??o.score)>limit);
      if(ok && allOver){
        players.forEach(p=>p.score=proj.get(p.id));
        gameOver=true;
        // mark history as cut win
        const last = cutsHistory.slice().reverse().find(h => h.round===roundCounter && h.id===cid);
        if (last) last.result="cut_win";
        showWinOverlay(players.find(p=>p.id===cid));
        save(); render(); return;
      }
    }

    /* Reenganche: ANY score ≥101 drops to max <= limit among others */
    players.forEach(p=>{
      let val=proj.get(p.id);
      if(val>=limit+1){
        const othersUnder=players.filter(o=>o.id!==p.id).map(o=>proj.get(o.id)).filter(v=>Number.isFinite(v)&&v<=limit);
        const maxUnder=othersUnder.length?Math.max(...othersUnder):0;
        proj.set(p.id, maxUnder);
        p.reenganches=(p.reenganches||0)+1;
      }
    });

    // apply totals
    players.forEach(p=>{ p.score=proj.get(p.id); });

    if(autoAdvanceDealer) advanceDealer();

    // if cutter existed but no special win, tag as normal cut
    if (cid){
      const last = cutsHistory.slice().reverse().find(h => h.round===roundCounter && h.id===cid);
      if (last && last.result==="played") last.result="normal";
    }

    gameOver=false; render();
  }

  /* CSV */
  const exportCSV=()=>{ const header=["name","score","reenganches","isDealer"]; const rows=players.map(p=>[csv(p.name), String(clampInt(p.score||0)), String(clampInt(p.reenganches||0)), String(p.id===nextDealerId)]); const all=[header].concat(rows).map(r=>r.join(",")).join("\n"); const blob=new Blob(["\ufeff",all],{type:"text/csv;charset=utf-8"}); const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="conga_scores.csv"; document.body.appendChild(a); a.click(); setTimeout(()=>{URL.revokeObjectURL(a.href); a.remove();},0); };
  const csv=s=>(/[",\n]/.test(s)?`"`+String(s).replace(/"/g,'""')+`"`:String(s));

  /* Win overlay + confetti */
  const winOverlay=document.getElementById('winOverlay');
  const winNameEl=document.getElementById('winName');
  const winPhotoEl=document.getElementById('winPhoto');
  const winSubEl=document.getElementById('winSubtitle');
  const winCloseBtn=document.getElementById('winCloseBtn');
  const winSound=document.getElementById('winSound');
  const confettiCanvas=document.getElementById('confettiCanvas');
  let confettiAnim;
  function showWinOverlay(winner){
    winNameEl.textContent = `${winner?.name || 'Winner'}`;
    winSubEl.textContent = (lang==="es"?"Partida terminada":"Game over");
    winPhotoEl.src = winner?.avatar || 'icons/icon-512.png';
    winOverlay.style.display='flex';
    startConfetti();
    try{winSound.currentTime=0; winSound.play().catch(()=>{});}catch{}
  }
  function hideWinOverlay(){ winOverlay.style.display='none'; stopConfetti(); }
  winCloseBtn.addEventListener('click', hideWinOverlay);
  winOverlay.addEventListener('click', (e)=>{ if(e.target===winOverlay) hideWinOverlay(); });
  function startConfetti(){
    const ctx=confettiCanvas.getContext('2d');
    const DPR=Math.max(1, window.devicePixelRatio||1);
    const resize=()=>{ confettiCanvas.width=confettiCanvas.clientWidth*DPR; confettiCanvas.height=confettiCanvas.clientHeight*DPR; };
    resize(); window.addEventListener('resize', resize);
    const colors=['#FFD166','#06D6A0','#118AB2','#EF476F','#A78BFA'];
    const pieces=Array.from({length:120},()=>({x:Math.random()*confettiCanvas.width,y:-Math.random()*confettiCanvas.height,r:2+Math.random()*4,c:colors[Math|Math.random()*colors.length],vx:-1+Math.random()*2,vy:1+Math.random()*2.5,a:Math.random()*Math.PI*2,va:-0.15+Math.random()*0.3}));
    (function step(){
      ctx.clearRect(0,0,confettiCanvas.width,confettiCanvas.height);
      for(const p of pieces){
        p.x+=p.vx; p.y+=p.vy; p.a+=p.va;
        if(p.y>confettiCanvas.height+20){ p.y=-10; p.x=Math.random()*confettiCanvas.width; }
        ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.a); ctx.fillStyle=p.c; ctx.fillRect(-p.r,-p.r,p.r*2,p.r*2); ctx.restore();
      }
      confettiAnim=requestAnimationFrame(step);
    })();
  }
  function stopConfetti(){ cancelAnimationFrame(confettiAnim); }

  /* Cropper */
  const cropDialog=document.getElementById('cropDialog');
  const cropCanvas=document.getElementById('cropCanvas');
  const cropCtx=cropCanvas.getContext('2d');
  const cropZoom=document.getElementById('cropZoom');
  const cropResetBtn=document.getElementById('cropReset');
  const cropSaveBtn=document.getElementById('cropSave');
  let cropImg=new Image(), cropTargetId=null, cx=0, cy=0, scale=1, isPanning=false, lastX=0, lastY=0, pinchStartDist=null, startScale=1;
  function openCropper(dataUrl, targetId){ cropTargetId=targetId; cropImg=new Image(); cropImg.onload=()=>{ scale=1; cx=0; cy=0; cropZoom.value='1'; drawCrop(); cropDialog.showModal(); }; cropImg.src=dataUrl; }
  function drawCrop(){
    const W=cropCanvas.width,H=cropCanvas.height; cropCtx.clearRect(0,0,W,H);
    cropCtx.save(); cropCtx.translate(W/2+cx, H/2+cy); cropCtx.scale(scale, scale);
    const ratio=Math.min(W/cropImg.width, H/cropImg.height); const w=cropImg.width*ratio, h=cropImg.height*ratio;
    cropCtx.drawImage(cropImg, -w/2, -h/2, w, h); cropCtx.restore();
    cropCtx.save(); cropCtx.fillStyle="rgba(0,0,0,.35)"; cropCtx.beginPath(); cropCtx.rect(0,0,W,H); cropCtx.arc(W/2,H/2,Math.min(W,H)*0.42,0,Math.PI*2,true); cropCtx.fill("evenodd"); cropCtx.restore();
    cropCtx.beginPath(); cropCtx.strokeStyle="rgba(255,255,255,.85)"; cropCtx.lineWidth=3; cropCtx.arc(W/2,H/2,Math.min(W,H)*0.42,0,Math.PI*2); cropCtx.stroke();
  }
  cropCanvas.addEventListener('mousedown', e=>{ isPanning=true; lastX=e.offsetX; lastY=e.offsetY; });
  window.addEventListener('mouseup', ()=>{ isPanning=false; });
  cropCanvas.addEventListener('mousemove', e=>{ if(!isPanning) return; cx+=(e.offsetX-lastX); cy+=(e.offsetY-lastY); lastX=e.offsetX; lastY=e.offsetY; drawCrop(); });
  cropCanvas.addEventListener('touchstart', e=>{ if(e.touches.length===2){ pinchStartDist=Math.hypot(e.touches[0].clientX-e.touches[1].clientX, e.touches[0].clientY-e.touches[1].clientY); startScale=scale; } else { isPanning=true; lastX=e.touches[0].clientX; lastY=e.touches[0].clientY; }},{passive:false});
  cropCanvas.addEventListener('touchmove', e=>{ e.preventDefault(); if(e.touches.length===2 && pinchStartDist){ const d=Math.hypot(e.touches[0].clientX-e.touches[1].clientX, e.touches[0].clientY-e.touches[1].clientY); scale=Math.min(3,Math.max(0.6, startScale*(d/pinchStartDist))); cropZoom.value=String(scale); drawCrop(); } else if(isPanning){ const x=e.touches[0].clientX,y=e.touches[0].clientY; cx+=(x-lastX); cy+=(y-lastY); lastX=x; lastY=y; drawCrop(); }},{passive:false});
  cropCanvas.addEventListener('touchend', ()=>{ isPanning=false; pinchStartDist=null; }, {passive:true});
  cropZoom.addEventListener('input', ()=>{ scale=+cropZoom.value; drawCrop(); });
  cropResetBtn.addEventListener('click', ()=>{ scale=1; cx=0; cy=0; cropZoom.value='1'; drawCrop(); });
  cropSaveBtn.addEventListener('click', ()=>{ const W=cropCanvas.width,H=cropCanvas.height; const out=document.createElement('canvas'); const octx=out.getContext('2d'); const R=Math.min(W,H)*0.42; out.width=out.height=R*2; octx.save(); octx.translate(R+cx, R+cy); octx.scale(scale, scale); const ratio=Math.min(W/cropImg.width, H/cropImg.height); const w=cropImg.width*ratio, h=cropImg.height*ratio; octx.beginPath(); octx.arc(0,0,R,0,Math.PI*2); octx.clip(); octx.drawImage(cropImg,-w/2,-h/2,w,h); octx.restore(); const dataURL=out.toDataURL('image/png',0.92); const p=players.find(x=>x.id===cropTargetId); if(p){ p.avatar=dataURL; render(); } cropDialog.close(); });

  /* History dialog */
  function openHistory(id){
    const list=$("#historyList"); list.innerHTML="";
    const my=cutsHistory.filter(h=>h.id===id).sort((a,b)=>a.round-b.round);
    if(my.length===0){ list.innerHTML='<div class="history-item">No cuts recorded.</div>'; }
    else{
      for(const h of my){
        const d=new Date(h.timestamp);
        const label=h.result==='cut_win'?'✂️🏆 Cut win':(h.result==='normal'?'✂️ Cut (no win)':'✂️ Cut');
        const row=document.createElement('div'); row.className='history-item'; row.textContent=`R${h.round} • ${label} • ${d.toLocaleString()}`;
        list.appendChild(row);
      }
    }
    historyDialog.showModal();
  }

  /* Wire-up */
  document.getElementById("addPlayerBtn").onclick=()=>{ const name=prompt(lang==="es"?"Nombre del jugador:":"Player name?"); if(name!==null) addPlayer(String(name).trim()||undefined); };
  document.getElementById("newRoundBtn").onclick=()=>openRound();
  document.getElementById("exportBtn").onclick=exportCSV;
  document.getElementById("limitInput").oninput=e=>{ const v=clampInt(e.target.value,limit); limit=Math.max(1,v); render(); };
  document.getElementById("autoAdvance").onchange=e=>{ autoAdvanceDealer=!!e.target.checked; render(); };
  document.getElementById("clearAllBtn").onclick=()=>{ if(confirm(lang==="es"?"¿Limpiar todos los jugadores y ajustes?":"Clear all players and settings?")){ players=[]; limit=100; nextDealerId=null; autoAdvanceDealer=true; gameOver=false; cutsHistory=[]; roundCounter=0; render(); } };
  document.getElementById("resetScoresBtn").onclick=()=>{ if(players.length&&confirm(lang==="es"?"¿Reiniciar todos los puntajes y reenganches?":"Reset all scores and reenganches?")){ players.forEach(p=>{p.score=0;p.reenganches=0;}); gameOver=false; render(); } };
  document.getElementById("newGameBtn").onclick=()=>{ players.forEach(p=>{p.score=0;p.reenganches=0;}); gameOver=false; render(); window.scrollTo({top:0,behavior:"smooth"}); };
  document.getElementById("roundForm").onsubmit=e=>{ e.preventDefault(); if(!validateRound()) return; const inputs=roundInputs(); const cid=selectedCutter(); if(cid){ const p=players.find(x=>x.id===cid); const projected=clampInt(p.score||0)+clampInt(inputs[p.id]??0); if(projected>limit){ document.getElementById("roundError").textContent=(I18N[lang].cutterExceeds||I18N.en.cutterExceeds)(limit,projected); document.getElementById("roundError").style.display=""; return; } } roundDlg.close(); applyRound(inputs,cid); };
  document.getElementById("langToggle").onclick=()=>{ lang=(lang==="es"?"en":"es"); save(); render(); };

  /* Init */
  load();
  if(players.length===0){ addPlayer(detectLang()==="es"?"Jugador 1":"Player 1"); addPlayer(detectLang()==="es"?"Jugador 2":"Player 2"); }
  document.getElementById("exportBtn").title=t("exportCSV"); document.getElementById("resetScoresBtn").title=t("resetTip"); render();

  /* SW */
  if('serviceWorker' in navigator){ window.addEventListener('load', ()=>{ navigator.serviceWorker.register('service-worker.js').catch(()=>{}); }); }
})();
</script>
</body>
</html>
