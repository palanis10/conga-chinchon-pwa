<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Conga / Chinch√≥n Scorekeeper</title>
<style>
  :root{
    --bg:#0f1115; --card:#171a21; --muted:#8b93a6; --text:#e7ecf3; --accent:#82ffc3; --danger:#ff6b6b; --ok:#9cff6b;
    --ring:#2a2f3a;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;background:var(--bg);color:var(--text)}
  header{position:sticky;top:0;z-index:5;background:linear-gradient(180deg,rgba(15,17,21,.95),rgba(15,17,21,.75));backdrop-filter:blur(8px);border-bottom:1px solid #1d2230}
  .wrap{max-width:940px;margin:0 auto;padding:16px}
  h1{margin:0;font-size:20px;letter-spacing:.3px}
  .toolbar{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
  button,.btn{appearance:none;border:1px solid #2a2f3a;background:#1b202b;color:var(--text);padding:10px 12px;border-radius:12px;font-weight:600;cursor:pointer}
  button:focus{outline:2px solid var(--accent);outline-offset:2px}
  .btn-primary{background:linear-gradient(180deg,#263244,#1f2734);border-color:#2d3a4e}
  .btn-accent{background:linear-gradient(180deg,#0e4,#0a4);color:#08150d;border-color:#0b5}
  .btn-danger{background:linear-gradient(180deg,#3a1d22,#2a1418);border-color:#5b232e;color:#ffd9df}
  .pill{padding:6px 10px;border-radius:999px;border:1px solid #2a2f3a;background:#141821;color:var(--muted);font-size:12px}
  .card{background:var(--card);border:1px solid #1d2230;border-radius:16px;box-shadow:0 8px 30px rgba(0,0,0,.25)}
  .row{display:flex;align-items:center;gap:10px}
  .players{margin-top:14px}
  .player{display:grid;grid-template-columns: 28px 1fr auto auto auto;gap:10px;align-items:center;padding:10px;border-bottom:1px solid #1d2230}
  .player:last-child{border-bottom:none}
  .handle{cursor:grab;opacity:.8}
  .avatar{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:#202635;border:1px solid #2a2f3a;font-weight:800}
  .name{font-size:20px;font-weight:800;line-height:1.1;letter-spacing:.2px}
  .rename{background:transparent;border:1px dashed #394558;border-radius:10px;padding:6px 8px;color:var(--muted)}
  .score{display:flex;align-items:center;gap:6px;font-variant-numeric:tabular-nums}
  .stars{color:#ffd166;letter-spacing:1px;font-size:18px;margin-right:2px}
  .score strong{font-size:22px}
  .edit{font-size:14px;opacity:.9}
  .edit button{transform:scale(1.1)}
  .dealerBtn{border-radius:999px;padding:6px 10px}
  .dealer{color:#a0cfff}
  .nextDealer{margin-top:10px}
  .muted{color:var(--muted)}
  .tiny{font-size:12px}
  .grid-2{display:grid;grid-template-columns:1fr;gap:12px}
  @media(min-width:640px){.grid-2{grid-template-columns:1fr 1fr}}

  /* Modal */
  dialog{border:none;border-radius:18px;max-width:720px;width:96vw;background:#111522;color:var(--text);padding:0;overflow:hidden}
  dialog::backdrop{background:rgba(0,0,0,.6)}
  .modal-head{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;border-bottom:1px solid #1c2130;background:#121829}
  .modal-body{padding:12px 12px 16px}
  .rtable{width:100%;border-collapse:separate;border-spacing:0 10px}
  .rtable th{font-size:12px;color:var(--muted);text-align:left;padding:0 8px}
  .rrow{display:grid;grid-template-columns:1fr 110px 72px 60px;gap:8px;align-items:center;background:#0f1422;border:1px solid #1e2740;border-radius:12px;padding:10px;margin:6px 0}
  .rrow input[type=number]{width:100%;padding:10px;border-radius:10px;border:1px solid #2a3552;background:#0d1321;color:var(--text);font-variant-numeric:tabular-nums}
  .rrow .minus10{padding:8px;border-radius:10px;border:1px solid #2a3552;background:#141b2d}
  .cutRadio{display:flex;align-items:center;justify-content:center}
  .modal-foot{display:flex;justify-content:flex-end;gap:10px;padding:12px 16px;border-top:1px solid #1c2130;background:#0f1422}

  /* History */
  .history{margin-top:16px;overflow:auto}
  table.scoreHistory{width:100%;border-collapse:collapse}
  .scoreHistory th,.scoreHistory td{border-bottom:1px solid #21283a;padding:8px;text-align:center}
  .scoreHistory th:first-child,.scoreHistory td:first-child{text-align:left}
  .scoreHistory tr:hover td{background:#121727}

  /* Winner overlay */
  .winWrap{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.65);z-index:50}
  .winCard{background:radial-gradient(1200px 700px at 50% -10%,rgba(130,255,195,.25),transparent 60%),#0e1320;border:2px solid #1e2f2a;border-radius:20px;padding:26px 22px;text-align:center;max-width:520px;width:94vw;box-shadow:0 30px 80px rgba(0,0,0,.6)}
  .winTitle{font-size:28px;margin:0 0 8px}
  .winName{font-size:34px;margin:8px 0 16px;color:var(--accent);font-weight:900;letter-spacing:.3px}
  .fireworks,.confetti{position:fixed;pointer-events:none;inset:0;z-index:60}
  .hidden{display:none !important}

  /* Small helpers */
  .flex{display:flex;gap:8px;align-items:center}
  .grow{flex:1}
  .right{margin-left:auto}
  .sep{height:1px;background:#1d2230;margin:8px 0}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>üÉè Conga / Chinch√≥n Scorekeeper</h1>
    <div class="toolbar">
      <button id="addPlayer" class="btn-primary">+ Add Player</button>
      <button id="enterRound" class="btn-accent">Enter Round</button>
      <button id="undoRound" class="">Undo Round</button>
      <button id="newGame" class="btn-danger">New Game</button>
      <span class="pill">Limit: 100 | Auto-advance dealer: ON</span>
      <span class="right pill" id="saveHint">Saved ‚úì</span>
    </div>
    <div class="nextDealer muted">Next dealer: <strong id="nextDealerName">‚Äî</strong></div>
  </div>
</header>

<main class="wrap">
  <section class="card">
    <div class="players" id="players"></div>
  </section>

  <section class="card history" style="padding:12px">
    <div class="row" style="justify-content:space-between;padding:8px 6px 0">
      <div class="muted">Rounds history (totals)</div>
      <div class="tiny muted" id="roundCount">0 rounds</div>
    </div>
    <div class="sep"></div>
    <div id="historyWrap" style="padding:6px 0;overflow:auto"></div>
  </section>
</main>

<!-- Round Modal -->
<dialog id="roundModal">
  <div class="modal-head">
    <div class="flex">
      <strong>Enter round</strong>
      <span class="pill">Tip: negatives allowed</span>
    </div>
    <button id="closeModal" class="rename">Close</button>
  </div>
  <div class="modal-body">
    <div class="tiny muted" style="margin-bottom:8px">If someone cut (<em>cort√≥</em>), select them. Cutter may NOT exceed 100 this hand.</div>
    <div id="roundRows"></div>
    <div id="cutterError" class="tiny" style="color:var(--danger);margin-top:4px;display:none">Cutter cannot exceed 100. Adjust scores.</div>
  </div>
  <div class="modal-foot">
    <button id="clearInputs" class="rename">Clear</button>
    <button id="applyRound" class="btn-accent">Apply</button>
  </div>
</dialog>

<!-- Winner Overlay -->
<div class="winWrap" id="winWrap">
  <canvas class="confetti" id="confetti"></canvas>
  <canvas class="fireworks" id="fireworks"></canvas>
  <div class="winCard">
    <h2 class="winTitle">üéâ We have a winner!</h2>
    <div class="winName" id="winName">‚Äî</div>
    <div class="muted" id="winNote"></div>
    <div style="margin-top:16px" class="flex" >
      <button id="closeWin" class="btn">Close</button>
      <button id="newGame2" class="btn-danger right">Start New Game</button>
    </div>
  </div>
  <audio id="winAudio"></audio>
</div>

<script>
/* ==============================
   State
============================== */
const LS_KEY = 'conga_state_v5';
const LIMIT = 100;

let state = {
  players: [
    {id: uid(), name:'Player 1', score:0, reenganches:0, out:false},
    {id: uid(), name:'Player 2', score:0, reenganches:0, out:false},
  ],
  order: [],             // array of ids in visual order
  rounds: [],            // {n, deltas: {id:delta}, totals:{id:total}, cutterId:null|id}
  nextDealerId: null,    // id
  autoAdvanceDealer: true
};

function load(){
  const raw = localStorage.getItem(LS_KEY);
  if(raw){
    try{ state = JSON.parse(raw); }catch(e){}
  }
  if(!state.order || state.order.length===0){
    state.order = state.players.map(p=>p.id);
  }
  if(!state.nextDealerId) state.nextDealerId = state.order[0];
}
function save(){
  localStorage.setItem(LS_KEY, JSON.stringify(state));
  flashSave();
}
function flashSave(){
  const el = document.getElementById('saveHint');
  el.textContent = 'Saved ‚úì';
  el.style.opacity = 1;
  setTimeout(()=>{ el.style.opacity=.5; },1200);
}
function uid(){ return 'p'+Math.random().toString(36).slice(2,9); }

/* ==============================
   Rendering
============================== */
const playersEl = document.getElementById('players');
const nextDealerNameEl = document.getElementById('nextDealerName');
function render(){
  // players list
  playersEl.innerHTML = '';
  state.order.forEach((id, idx)=>{
    const p = state.players.find(x=>x.id===id);
    const row = document.createElement('div');
    row.className = 'player';
    row.draggable = true;
    row.dataset.id = p.id;

    const handle = document.createElement('div');
    handle.className = 'handle muted';
    handle.innerHTML = '‚ò∞';

    const nameWrap = document.createElement('div');
    const name = document.createElement('div');
    name.className = 'name';
    name.contentEditable = true;
    name.spellcheck = false;
    name.innerText = p.name;
    name.addEventListener('blur', ()=>{
      p.name = name.innerText.trim() || p.name;
      renderHistory();
      renderDealer();
      save();
    });
    const muted = document.createElement('div');
    muted.className='tiny muted';
    muted.innerText = p.out ? 'Out' : 'In game';
    nameWrap.append(name, muted);

    const score = document.createElement('div');
    score.className = 'score';
    const stars = document.createElement('span');
    stars.className = 'stars';
    stars.title = `${p.reenganches} reenganche(s)`;
    stars.textContent = '‚òÖ'.repeat(p.reenganches);
    const strong = document.createElement('strong');
    strong.textContent = p.score;
    score.append(stars,strong);

    const edit = document.createElement('div');
    edit.className = 'edit';
    const minus = document.createElement('button');
    minus.title='-10 quick';
    minus.textContent='‚àí10';
    minus.addEventListener('click', ()=>{
      applyRoundQuick({[p.id]: -10});
    });
    const del = document.createElement('button');
    del.textContent='Remove';
    del.addEventListener('click', ()=>{
      if(confirm('Remove player?')) {
        state.players = state.players.filter(x=>x.id!==p.id);
        state.order = state.order.filter(x=>x!==p.id);
        if(state.nextDealerId===p.id){
          state.nextDealerId = state.order[0] || null;
        }
        renderAll();
        save();
      }
    });
    edit.append(minus, del);

    const dealerBtn = document.createElement('button');
    dealerBtn.className = 'dealerBtn';
    if(state.nextDealerId===p.id) dealerBtn.classList.add('dealer');
    dealerBtn.title='Set next dealer';
    dealerBtn.textContent='Dealer';
    dealerBtn.addEventListener('click', ()=>{
      state.nextDealerId = p.id;
      renderDealer();
      save();
    });

    row.append(handle, nameWrap, score, edit, dealerBtn);
    playersEl.appendChild(row);
  });
  enableDnD();
  renderDealer();
  renderHistory();
}
function renderDealer(){
  const p = state.players.find(x=>x.id===state.nextDealerId);
  nextDealerNameEl.textContent = p ? p.name : '‚Äî';
  // update dealer highlight
  document.querySelectorAll('.player .dealerBtn').forEach((btn,i)=>{
    const id = state.order[i];
    btn.classList.toggle('dealer', state.nextDealerId===id);
  });
}
function renderHistory(){
  const wrap = document.getElementById('historyWrap');
  const rc = document.getElementById('roundCount');
  rc.textContent = `${state.rounds.length} round${state.rounds.length===1?'':'s'}`;
  if(state.rounds.length===0){
    wrap.innerHTML = `<div class="muted tiny" style="padding:8px 4px">No rounds yet. Click <strong>Enter Round</strong> to begin.</div>`;
    return;
  }
  // Table header: Round, then each player in current order
  const header = ['Round', ...state.order.map(id=>{
    const p = state.players.find(x=>x.id===id);
    return p ? p.name : '‚Äî';
  })];
  // Rows: each round totals per player
  const rows = state.rounds.map(r=>{
    const tds = [String(r.n)];
    state.order.forEach(id=>{
      const val = r.totals[id];
      tds.push(val===undefined ? '' : String(val));
    });
    return tds;
  });
  // Render
  let html = `<table class="scoreHistory"><thead><tr>${header.map(h=>`<th>${escapeHtml(h)}</th>`).join('')}</tr></thead><tbody>`;
  rows.forEach(r=>{
    html += `<tr>${r.map((c,i)=> i===0 ? `<td style="text-align:left">${c}</td>` : `<td>${c}</td>`).join('')}</tr>`;
  });
  html += `</tbody></table>`;
  wrap.innerHTML = html;
}

/* ==============================
   Drag & Drop (HTML5)
============================== */
function enableDnD(){
  document.querySelectorAll('.player').forEach(row=>{
    row.addEventListener('dragstart', (e)=>{
      row.classList.add('dragging');
      e.dataTransfer.setData('text/plain', row.dataset.id);
    });
    row.addEventListener('dragend', ()=> row.classList.remove('dragging'));
  });
  playersEl.addEventListener('dragover', (e)=>{
    e.preventDefault();
    const dragging = document.querySelector('.player.dragging');
    const after = getDragAfterElement(playersEl, e.clientY);
    if(after==null){
      playersEl.appendChild(dragging);
    }else{
      playersEl.insertBefore(dragging, after);
    }
  });
  playersEl.addEventListener('drop', ()=>{
    // update order without changing nextDealerId (dealer is by id)
    const ids = Array.from(document.querySelectorAll('.player')).map(el=>el.dataset.id);
    state.order = ids;
    renderHistory(); // history uses header order
    save();
  });
}
function getDragAfterElement(container, y){
  const els = [...container.querySelectorAll('.player:not(.dragging)')];
  return els.reduce((closest, child)=>{
    const box = child.getBoundingClientRect();
    const offset = y - box.top - box.height/2;
    if(offset < 0 && offset > closest.offset){ return {offset, element: child}; }
    else return closest;
  }, {offset: Number.NEGATIVE_INFINITY}).element;
}

/* ==============================
   Round Modal
============================== */
const modal = document.getElementById('roundModal');
const roundRows = document.getElementById('roundRows');
const cutterError = document.getElementById('cutterError');

function openRoundModal(){
  roundRows.innerHTML = '';
  const flex = document.createElement('div');
  // header row
  consthdr();
  // rows
  state.order.forEach(id=>{
    const p = state.players.find(x=>x.id===id);
    const row = document.createElement('div');
    row.className='rrow';
    // name
    const name = document.createElement('div'); name.textContent = p.name;
    // number input
    const inp = document.createElement('input'); inp.type='number'; inp.step='1'; inp.value='0';
    inp.dataset.pid = p.id;
    // minus10
    const btn = document.createElement('button'); btn.className='minus10'; btn.textContent='‚àí10';
    btn.addEventListener('click', ()=>{ inp.value = String((+inp.value||0) - 10); validateCutter(); });
    // radio
    const radWrap = document.createElement('label'); radWrap.className='cutRadio';
    const rad = document.createElement('input'); rad.type='radio'; rad.name='cutter'; rad.value = p.id;
    rad.addEventListener('change', validateCutter);
    radWrap.appendChild(rad);

    row.append(name, inp, btn, radWrap);
    roundRows.appendChild(row);
  });
  modal.showModal();
  cutterError.style.display='none';
}
function consthdr(){
  const head = document.createElement('div');
  head.className='rrow';
  head.innerHTML = `<div class="tiny muted">Player</div>
                    <div class="tiny muted">Points (Œî)</div>
                    <div class="tiny muted">Quick</div>
                    <div class="tiny muted">Cort√≥</div>`;
  roundRows.appendChild(head);
}

function getRoundInputs(){
  const deltas = {};
  document.querySelectorAll('#roundRows input[type=number]').forEach(inp=>{
    const id = inp.dataset.pid;
    deltas[id] = Number(inp.value||0);
  });
  const cutter = (document.querySelector('#roundRows input[type=radio]:checked')||{}).value || null;
  return {deltas, cutterId: cutter};
}

function validateCutter(){
  const {deltas, cutterId} = getRoundInputs();
  if(!cutterId){ cutterError.style.display='none'; return true; }
  const p = state.players.find(x=>x.id===cutterId);
  const projected = p.score + (deltas[cutterId]||0);
  const ok = projected <= LIMIT;
  cutterError.style.display = ok ? 'none' : 'block';
  return ok;
}

function clearRoundInputs(){ 
  document.querySelectorAll('#roundRows input[type=number]').forEach(inp=> inp.value = '0');
  document.querySelectorAll('#roundRows input[type=radio]').forEach(r=> r.checked=false);
  validateCutter();
}

function applyRoundQuick(deltas){
  // helper for -10 quick on row
  const all = {}; state.players.forEach(p=> all[p.id]=0);
  Object.assign(all, deltas);
  const result = processRound(all, null);
  if(result.winner){ showWinner(result.winner, result.reason); }
  renderAll(); save();
}

function processRound(deltas, cutterId){
  // Build projected
  const projected = {};
  const before = {};
  const wasIn = {};
  state.players.forEach(p=>{
    before[p.id] = p.score;
    const delta = deltas[p.id]||0;
    projected[p.id] = p.score + delta;
    wasIn[p.id] = !p.out && p.score <= LIMIT;
  });

  // Cutter validation (already UI-validated but enforce)
  if(cutterId){
    if(projected[cutterId] > LIMIT) {
      alert('Cutter cannot exceed 100. Adjust scores.');
      return {error:true};
    }
  }

  // Instant win: cutter <=100 and EVERY other player >100 => cutter wins, no reenganche, no dealer advance
  if(cutterId){
    const cutterProjected = projected[cutterId];
    const othersAllOut = state.players
      .filter(p=>p.id!==cutterId)
      .every(p=> (projected[p.id] > LIMIT));
    const cutterWasIn = (before[cutterId] <= LIMIT) && !state.players.find(p=>p.id===cutterId).out;
    if(cutterWasIn && cutterProjected <= LIMIT && othersAllOut){
      // apply scores straight, then winner
      state.players.forEach(p=>{
        p.score = projected[p.id];
        if(p.id!==cutterId && projected[p.id] > LIMIT) p.out = true;
      });
      pushRound(deltas, cutterId);
      return {winner: cutterId, reason:'Cutter wins (others exceeded 100).'};
    }
  }

  // General application with reenganche (only at 101)
  // Determine value for reenganche: max ‚â§ LIMIT among projected (or 0 if none)
  const maxLE = maxUnderOrEqual(projected, LIMIT);
  const haveLE = Number.isFinite(maxLE);
  const reengValue = haveLE ? maxLE : 0;

  state.players.forEach(p=>{
    const pj = projected[p.id];
    if(pj <= LIMIT){
      p.score = pj;
      if(p.out && pj <= LIMIT) p.out = false; // in case of earlier status
    }else{
      if(pj === 101){ // reenganche allowed exactly at 101
        p.score = reengValue;
        p.reenganches = (p.reenganches||0) + 1;
        p.out = false;
      }else{
        p.score = pj;
        p.out = true;
      }
    }
  });

  pushRound(deltas, cutterId);

  // Check win conditions after applying:
  // If exactly one player remains ‚â§100 and others >100, that player wins.
  const inPlayers = state.players.filter(p=>p.score <= LIMIT);
  const outPlayers = state.players.filter(p=>p.score > LIMIT);
  if(inPlayers.length===1 && outPlayers.length>=1){
    return {winner: inPlayers[0].id, reason:'Last player under 100.'};
  }
  return {};
}

function maxUnderOrEqual(obj, limit){
  // obj is map id -> number
  let max = -Infinity;
  Object.values(obj).forEach(v=>{
    if(v<=limit && v>max) max=v;
  });
  return max;
}

function pushRound(deltas, cutterId){
  const totals = {};
  state.players.forEach(p=> totals[p.id] = p.score);
  state.rounds.push({
    n: state.rounds.length+1,
    deltas,
    totals,
    cutterId: cutterId || null
  });
  // Dealer advance to next active (‚â§100). Keep dealer by id across reorders.
  if(state.autoAdvanceDealer && state.order.length){
    const idx = state.order.indexOf(state.nextDealerId);
    for(let step=1; step<=state.order.length; step++){
      const nextId = state.order[(idx+step)%state.order.length];
      const p = state.players.find(x=>x.id===nextId);
      if(p && p.score<=LIMIT){ state.nextDealerId = nextId; break; }
    }
  }
}

/* ==============================
   Winner UI (confetti + fireworks + sound)
============================== */
const winWrap = document.getElementById('winWrap');
const winNameEl = document.getElementById('winName');
const winNoteEl = document.getElementById('winNote');
const winAudio = document.getElementById('winAudio');

function showWinner(winnerId, note){
  const p = state.players.find(x=>x.id===winnerId);
  winNameEl.textContent = p ? p.name : '‚Äî';
  winNoteEl.textContent = note||'';
  winWrap.style.display = 'flex';
  startConfetti();
  startFireworks();
  playHappy();
}
function closeWinner(){
  stopConfetti(); stopFireworks();
  winWrap.style.display = 'none';
}
function playHappy(){
  // Simple WebAudio arpeggio (no external file)
  const ctx = new (window.AudioContext||window.webkitAudioContext)();
  const freqs = [523.25,659.25,783.99,1046.5]; // C5 E5 G5 C6
  let t = ctx.currentTime;
  freqs.forEach((f,i)=>{
    const o = ctx.createOscillator(); o.type='triangle'; o.frequency.value=f;
    const g = ctx.createGain(); g.gain.value=0.0001;
    o.connect(g); g.connect(ctx.destination);
    g.gain.exponentialRampToValueAtTime(0.4, t+.02);
    g.gain.exponentialRampToValueAtTime(0.001, t+.20);
    o.start(t+.02*i); o.stop(t+.25+.02*i);
  });
}

/* === Confetti === */
let confettiRAF = null, confettiCtx=null, confettiParts=[];
function startConfetti(){
  const canvas = document.getElementById('confetti');
  canvas.width = innerWidth; canvas.height = innerHeight;
  confettiCtx = canvas.getContext('2d');
  confettiParts = Array.from({length:200}).map(()=>({
    x: Math.random()*canvas.width,
    y: -20 - Math.random()*canvas.height,
    w: 6+Math.random()*6,
    h: 10+Math.random()*14,
    vy: 2+Math.random()*3,
    vx: -1+Math.random()*2,
    rot: Math.random()*Math.PI,
    vr: -0.2+Math.random()*0.4
  }));
  const draw = ()=>{
    confettiRAF = requestAnimationFrame(draw);
    confettiCtx.clearRect(0,0,canvas.width,canvas.height);
    confettiParts.forEach(p=>{
      p.y += p.vy; p.x += p.vx; p.rot += p.vr;
      if(p.y>canvas.height+30) { p.y = -20; p.x = Math.random()*canvas.width; }
      confettiCtx.save();
      confettiCtx.translate(p.x, p.y);
      confettiCtx.rotate(p.rot);
      confettiCtx.fillStyle = `hsl(${(p.x/5)%360} 80% 60%)`;
      confettiCtx.fillRect(-p.w/2,-p.h/2,p.w,p.h);
      confettiCtx.restore();
    });
  };
  draw();
}
function stopConfetti(){ cancelAnimationFrame(confettiRAF); }

/* === Fireworks === */
let fwRAF=null, fwCtx=null, fwParticles=[], fwTick=0;
function startFireworks(){
  const canvas = document.getElementById('fireworks');
  canvas.width = innerWidth; canvas.height = innerHeight;
  fwCtx = canvas.getContext('2d'); fwParticles=[];
  const burst = ()=>{
    const cx = Math.random()*canvas.width, cy = 150+Math.random()*canvas.height/2;
    const count = 80;
    for(let i=0;i<count;i++){
      const a = (Math.PI*2)*i/count;
      const sp = 2+Math.random()*3;
      fwParticles.push({x:cx,y:cy,vx:Math.cos(a)*sp,vy:Math.sin(a)*sp,life:60,age:0,h:Math.floor(Math.random()*360)});
    }
  };
  const draw = ()=>{
    fwRAF = requestAnimationFrame(draw);
    fwCtx.fillStyle='rgba(0,0,0,.15)'; fwCtx.fillRect(0,0,canvas.width,canvas.height);
    if(fwTick%25===0) burst();
    fwTick++;
    fwParticles.forEach(p=>{
      p.x += p.vx; p.y += p.vy; p.vy += 0.02; p.age++;
      fwCtx.beginPath(); fwCtx.arc(p.x,p.y,2,0,Math.PI*2);
      fwCtx.fillStyle=`hsl(${p.h} 90% 70%)`; fwCtx.fill();
    });
    fwParticles = fwParticles.filter(p=>p.age < p.life);
  };
  draw();
}
function stopFireworks(){ cancelAnimationFrame(fwRAF); fwParticles=[]; }

/* ==============================
   Events
============================== */
function renderAll(){ render(); }
document.getElementById('addPlayer').addEventListener('click', ()=>{
  const name = prompt('Player name');
  if(!name) return;
  const p = {id: uid(), name, score:0, reenganches:0, out:false};
  state.players.push(p); state.order.push(p.id);
  if(!state.nextDealerId) state.nextDealerId = p.id;
  renderAll(); save();
});
document.getElementById('enterRound').addEventListener('click', ()=>{
  if(state.players.length<2){ alert('Need at least 2 players.'); return; }
  openRoundModal();
});
document.getElementById('undoRound').addEventListener('click', ()=>{
  const last = state.rounds[state.rounds.length-1];
  if(!last){ alert('No rounds to undo.'); return; }
  if(!confirm('Undo last round?')) return;
  // Restore from previous totals or initial zeros
  state.rounds.pop();
  if(state.rounds.length===0){
    state.players.forEach(p=>{ p.score=0; p.out=false; p.reenganches=0; });
  }else{
    const prev = state.rounds[state.rounds.length-1];
    state.players.forEach(p=>{
      p.score = prev.totals[p.id] ?? 0;
      p.out = p.score>LIMIT;
    });
    // Recompute reenganches from history (count times pj became 101 ‚Üí star)
    recomputeReenganches();
  }
  renderAll(); save();
});
document.getElementById('newGame').addEventListener('click', newGame);
document.getElementById('newGame2').addEventListener('click', ()=>{ newGame(); closeWinner(); });
document.getElementById('closeModal').addEventListener('click', ()=> modal.close());
document.getElementById('clearInputs').addEventListener('click', clearRoundInputs);
document.getElementById('applyRound').addEventListener('click', ()=>{
  if(!validateCutter()) return;
  const {deltas, cutterId} = getRoundInputs();
  const result = processRound(deltas, cutterId);
  modal.close();
  renderAll(); save();
  if(result && result.winner){ showWinner(result.winner, result.reason); }
});
document.getElementById('closeWin').addEventListener('click', closeWinner);

function newGame(){
  if(!confirm('Start a new game? Scores & history will reset.')) return;
  state.players.forEach(p=>{ p.score=0; p.out=false; p.reenganches=0; });
  state.rounds = [];
  state.nextDealerId = state.order[0] || null;
  closeWinner();
  renderAll(); save();
}

function recomputeReenganches(){
  // Approximation: count transitions where total == value chosen by reenganche *after* being 101 in projected.
  // Since we don't store projections per history, we estimate: count how many times a player's total decreased from >100 to ‚â§100 across rounds.
  state.players.forEach(p=>p.reenganches=0);
  for(let i=1;i<state.rounds.length;i++){
    const prev = state.rounds[i-1], cur = state.rounds[i];
    state.players.forEach(p=>{
      const a = prev.totals[p.id] ?? 0;
      const b = cur.totals[p.id] ?? 0;
      if(a>LIMIT && b<=LIMIT) p.reenganches++;
    });
  }
}

/* ==============================
   Utils
============================== */
function escapeHtml(s){ return String(s).replace(/[&<>"]/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c])); }

/* ==============================
   Boot
============================== */
load();
renderAll();

/* Keep canvas sizes on resize */
addEventListener('resize', ()=>{
  const c1 = document.getElementById('confetti'); c1.width = innerWidth; c1.height=innerHeight;
  const c2 = document.getElementById('fireworks'); c2.width = innerWidth; c2.height=innerHeight;
});
</script>
</body>
</html>
